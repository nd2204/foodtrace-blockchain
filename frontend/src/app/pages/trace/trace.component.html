<div class="page">
  <header class="page-header">
    <div>
      <h1>{{ 'PAGES.TRACE.TITLE' | translate }}</h1>
      <p class="page-subtitle">
        {{ 'PAGES.TRACE.SUBTITLE' | translate }}
      </p>
    </div>
  </header>

  <form class="trace-form" (ngSubmit)="trace()">
    <input
      type="text"
      [(ngModel)]="code"
      name="code"
      [placeholder]="'PAGES.TRACE.PLACEHOLDER' | translate"
      required
    />
    <button type="submit" class="btn-primary" [disabled]="isLoading">
      {{ isLoading ? ('COMMON.LOADING' | translate) : ('PAGES.TRACE.BTN_SEARCH' | translate) }}
    </button>
  </form>

  <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <div class="trace-result" *ngIf="result">

    <div class="blockchain-status"
         [class.verified]="result.blockchain?.verified"
         [class.unverified]="!result.blockchain?.verified">

      <div class="bc-icon">
        {{ result.blockchain?.verified ? '‚úÖ' : '‚ö†Ô∏è' }}
      </div>

      <div class="bc-info">
        <strong>
          {{ result.blockchain?.verified ? 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c tr√™n Blockchain' : 'D·ªØ li·ªáu ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c tr√™n Blockchain' }}
        </strong>
        <div class="tx-hash" *ngIf="result.blockchain?.verified">
          TxHash: {{ result.blockchain?.blockchain_tx }}
        </div>
        <div class="tx-hash" *ngIf="!result.blockchain?.verified">
          C·∫£nh b√°o: D·ªØ li·ªáu n√†y c√≥ th·ªÉ ch∆∞a ƒë∆∞·ª£c ƒë·ªìng b·ªô ho·∫∑c ƒë√£ b·ªã thay ƒë·ªïi.
        </div>
      </div>
    </div>

    <div class="trace-header">
      <div>
        <h3 class="product-name">{{ result.product?.name || 'S·∫£n ph·∫©m ch∆∞a ƒë·∫∑t t√™n' }}</h3>
        <p class="product-desc">{{ result.product?.description }}</p>

        <div class="meta-grid">
          <div class="meta-item">
            <span class="label">M√£ l√¥ h√†ng:</span>
            <span class="value highlight">{{ result.batch?.batch_number }}</span>
          </div>
          <div class="meta-item">
            <span class="label">N√¥ng tr·∫°i:</span>
            <span class="value">{{ result.farm?.farm_name || 'N/A' }}</span>
          </div>
          <div class="meta-item">
            <span class="label">Ng√†y s·∫£n xu·∫•t:</span>
            <span class="value">{{ result.batch?.production_date | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="timeline-section">
      <h4>H√†nh tr√¨nh s·∫£n ph·∫©m</h4>
      <div class="timeline">
        <div
          class="timeline-item"
          *ngFor="let e of timelineEvents; let i = index"
          [ngClass]="['timeline-' + e.status, e.isBlockchain ? 'timeline-blockchain' : '']"
        >
          <div class="timeline-dot"></div>
          <div class="timeline-line" *ngIf="i < timelineEvents.length - 1"></div>

          <div class="timeline-content">
            <div class="timeline-title">
              {{ e.label }}
              <span class="badge" [class.badge-bc]="e.isBlockchain">
                {{ e.isBlockchain ? 'Blockchain' : 'Ho√†n th√†nh' }}
              </span>
            </div>
            <p class="timeline-meta">
              <span>‚è± {{ e.time }}</span>
              <span>üìç {{ e.location }}</span>
            </p>
            <p class="timeline-actor">üë§ {{ e.actor }}</p>
            <p class="timeline-note" *ngIf="e.note">{{ e.note }}</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
